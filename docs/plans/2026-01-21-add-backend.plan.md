# Add Backend for User Data Implementation Plan (with Prisma)

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** To create a backend service to store user-specific data (favorites, watchlist, lists) in a PostgreSQL database using Prisma ORM, and integrate it with the existing React frontend.

**Architecture:** We will build a simple Node.js application with an Express server. This server will expose a REST API to manage user data. We will use **Prisma ORM** to interact with the PostgreSQL database, providing a type-safe and efficient way to query and manage data. The frontend will be updated to call this new API instead of the TMDB API for user-specific actions.

**Tech Stack:**
- **Backend:** Node.js, Express, **Prisma ORM**
- **Database:** PostgreSQL
- **Frontend:** React

---

### Task 1: Set up the Backend Project with Prisma

**Files:**
- Create: `server/package.json`
- Create: `server/server.js`
- Create: `server/.env`
- Create: `server/prisma/schema.prisma` (new)
- Create: `server/prisma/migrations/...` (new, generated by Prisma)

**Step 1: Create the `server` directory and initialize a new Node.js project**

Run:
```bash
mkdir server
cd server
npm init -y
```

**Step 2: Install backend dependencies (including Prisma)**

Run:
```bash
npm install express dotenv cors @prisma/client
npm install --save-dev prisma # Install Prisma CLI as a dev dependency
```

**Step 3: Initialize Prisma**

This will create a `prisma` directory with a `schema.prisma` file and configure a `.env` file to use `DATABASE_URL`.

Run:
```bash
npx prisma init
```

**Step 4: Update `.env` file for Prisma and application**

`server/.env`:
```
DATABASE_URL="postgresql://YOUR_USER:YOUR_PASSWORD@YOUR_HOST:YOUR_PORT/YOUR_DATABASE?schema=public"
PORT=3001
```
*(Remember to replace placeholders with your actual PostgreSQL credentials.)*

**Step 5: Define the Prisma Schema**

Open `server/prisma/schema.prisma` and define your data models. This replaces the raw SQL table creation.

`server/prisma/schema.prisma`:
```prisma
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int       @id @default(autoincrement())
  username  String    @unique
  favorites Favorite[]
  watchlist Watchlist[]
  lists     List[]
}

model Favorite {
  id        Int       @id @default(autoincrement())
  userId    Int
  user      User      @relation(fields: [userId], references: [id])
  movieId   Int

  @@unique([userId, movieId]) // A user can only favorite a movie once
}

model Watchlist {
  id        Int       @id @default(autoincrement())
  userId    Int
  user      User      @relation(fields: [userId], references: [id])
  movieId   Int

  @@unique([userId, movieId]) // A user can only add a movie to watchlist once
}

model List {
  id        Int       @id @default(autoincrement())
  userId    Int
  user      User      @relation(fields: [userId], references: [id])
  name      String
  listMovies ListMovie[]
}

model ListMovie {
  id        Int       @id @default(autoincrement())
  listId    Int
  list      List      @relation(fields: [listId], references: [id])
  movieId   Int

  @@unique([listId, movieId]) // A movie can only be in a list once
}
```

**Step 6: Run Prisma Migrations and Generate Prisma Client**

This will create the database tables based on your schema and generate the Prisma Client code.

Run:
```bash
npx prisma migrate dev --name init
npx prisma generate
```

**Step 7: Create the basic Express server**

`server/server.js`:
```javascript
const express = require('express');
const cors = require('cors');
require('dotenv').config(); // Load environment variables from .env file

const { PrismaClient } = require('@prisma/client'); // Import PrismaClient
const prisma = new PrismaClient(); // Instantiate PrismaClient

const app = express();
app.use(cors());
app.use(express.json());

const port = process.env.PORT || 3001;

app.get('/', (req, res) => {
  res.send('Backend server is running!');
});

// A simple endpoint to test database connection through Prisma
app.get('/test-db', async (req, res) => {
  try {
    await prisma.$connect(); // Attempt to connect
    res.json({ message: 'Database connected successfully via Prisma!' });
  } catch (err) {
    console.error('Database connection error:', err);
    res.status(500).send('Database connection error via Prisma.');
  } finally {
    await prisma.$disconnect(); // Disconnect after test
  }
});

app.listen(port, () => {
  console.log(`Server is running on port ${port}`);
});

// Export prisma client for other modules if needed (e.g., routes)
module.exports = prisma;
```

**Step 8: Add scripts to `server/package.json` for Prisma**

Modify `server/package.json`:
```json
"scripts": {
  "start": "node server.js",
  "prisma:migrate": "npx prisma migrate dev",
  "prisma:generate": "npx prisma generate"
},
"devDependencies": {
  "prisma": "^5.14.0" // Using current stable version as of writing
}
```

**Step 9: Commit the initial backend setup with Prisma**

```bash
git add server/
git commit -m "feat: initial backend setup with Prisma"
```

### Task 2: Implement API Endpoints for Favorites (using Prisma)

**Files:**
- Create: `server/routes/favorites.js`
- Modify: `server/server.js`

**Step 1: Create the favorites routes**

`server/routes/favorites.js`:
```javascript
const express = require('express');
const router = express.Router();
const prisma = require('../server'); // Import prisma client from server.js

// Get all favorite movie IDs for a user
router.get('/:userId', async (req, res) => {
  const { userId } = req.params;
  try {
    const favorites = await prisma.favorite.findMany({
      where: { userId: parseInt(userId) },
      select: { movieId: true },
    });
    res.json(favorites.map(fav => fav.movieId));
  } catch (err) {
    console.error(err);
    res.status(500).send('Server error fetching favorites');
  }
});

// Add a movie to favorites
router.post('/', async (req, res) => {
  const { userId, movieId } = req.body;
  try {
    await prisma.favorite.create({
      data: {
        userId: parseInt(userId),
        movieId: parseInt(movieId),
      },
    });
    res.status(201).send('Favorite added');
  } catch (err) {
    console.error(err);
    // Handle unique constraint violation if a movie is already favorited
    if (err.code === 'P2002') {
      return res.status(409).send('Movie already in favorites');
    }
    res.status(500).send('Server error adding favorite');
  }
});

// Remove a movie from favorites
router.delete('/', async (req, res) => {
  const { userId, movieId } = req.body;
  try {
    await prisma.favorite.deleteMany({ // deleteMany because @@unique ensures only one entry
      where: {
        userId: parseInt(userId),
        movieId: parseInt(movieId),
      },
    });
    res.status(204).send(); // No content for successful deletion
  } catch (err) {
    console.error(err);
    res.status(500).send('Server error removing favorite');
  }
});

module.exports = router;
```

**Step 2: Use the favorites routes in the server**

Modify `server/server.js` (after the `/test-db` route and before `app.listen`):
```javascript
// ... existing code ...
const favoritesRouter = require('./routes/favorites');
app.use('/api/favorites', favoritesRouter);
// ... existing code ...
```

**Step 3: Commit the favorites API endpoints with Prisma**

```bash
git add server/routes/favorites.js server/server.js
git commit -m "feat: implement favorites API endpoints with Prisma"
```

### Task 3: Implement API Endpoints for Watchlist (using Prisma) - NEW TASK

**Files:**
- Create: `server/routes/watchlist.js`
- Modify: `server/server.js`

**Step 1: Create the watchlist routes**

`server/routes/watchlist.js`:
```javascript
const express = require('express');
const router = express.Router();
const prisma = require('../server'); // Import prisma client from server.js

// Get all watchlist movie IDs for a user
router.get('/:userId', async (req, res) => {
  const { userId } = req.params;
  try {
    const watchlist = await prisma.watchlist.findMany({
      where: { userId: parseInt(userId) },
      select: { movieId: true },
    });
    res.json(watchlist.map(item => item.movieId));
  } catch (err) {
    console.error(err);
    res.status(500).send('Server error fetching watchlist');
  }
});

// Add a movie to watchlist
router.post('/', async (req, res) => {
  const { userId, movieId } = req.body;
  try {
    await prisma.watchlist.create({
      data: {
        userId: parseInt(userId),
        movieId: parseInt(movieId),
      },
    });
    res.status(201).send('Movie added to watchlist');
  } catch (err) {
    console.error(err);
    if (err.code === 'P2002') {
      return res.status(409).send('Movie already in watchlist');
    }
    res.status(500).send('Server error adding movie to watchlist');
  }
});

// Remove a movie from watchlist
router.delete('/', async (req, res) => {
  const { userId, movieId } = req.body;
  try {
    await prisma.watchlist.deleteMany({
      where: {
        userId: parseInt(userId),
        movieId: parseInt(movieId),
      },
    });
    res.status(204).send();
  } catch (err) {
    console.error(err);
    res.status(500).send('Server error removing movie from watchlist');
  }
});

module.exports = router;
```

**Step 2: Use the watchlist routes in the server**

Modify `server/server.js` (after `app.use('/api/favorites', favoritesRouter);`):
```javascript
// ... existing code ...
const watchlistRouter = require('./routes/watchlist');
app.use('/api/watchlist', watchlistRouter);
// ... existing code ...
```

**Step 3: Commit the watchlist API endpoints with Prisma**

```bash
git add server/routes/watchlist.js server/server.js
git commit -m "feat: implement watchlist API endpoints with Prisma"
```

### Task 4: Implement API Endpoints for Custom Lists (using Prisma) - NEW TASK

**Files:**
- Create: `server/routes/lists.js`
- Modify: `server/server.js`

**Step 1: Create the custom lists routes**

`server/routes/lists.js`:
```javascript
const express = require('express');
const router = express.Router();
const prisma = require('../server'); // Import prisma client from server.js

// Get all custom lists for a user
router.get('/:userId', async (req, res) => {
  const { userId } = req.params;
  try {
    const lists = await prisma.list.findMany({
      where: { userId: parseInt(userId) },
      include: { listMovies: { select: { movieId: true } } }, // Include movie IDs in each list
    });
    res.json(lists);
  } catch (err) {
    console.error(err);
    res.status(500).send('Server error fetching lists');
  }
});

// Create a new custom list
router.post('/', async (req, res) => {
  const { userId, name } = req.body;
  try {
    const newList = await prisma.list.create({
      data: {
        userId: parseInt(userId),
        name,
      },
    });
    res.status(201).json(newList);
  } catch (err) {
    console.error(err);
    res.status(500).send('Server error creating list');
  }
});

// Add a movie to a custom list
router.post('/:listId/movies', async (req, res) => {
  const { listId } = req.params;
  const { movieId } = req.body;
  try {
    await prisma.listMovie.create({
      data: {
        listId: parseInt(listId),
        movieId: parseInt(movieId),
      },
    });
    res.status(201).send('Movie added to list');
  } catch (err) {
    console.error(err);
    if (err.code === 'P2002') {
      return res.status(409).send('Movie already in this list');
    }
    res.status(500).send('Server error adding movie to list');
  }
});

// Remove a movie from a custom list
router.delete('/:listId/movies', async (req, res) => {
  const { listId } = req.params;
  const { movieId } = req.body;
  try {
    await prisma.listMovie.deleteMany({
      where: {
        listId: parseInt(listId),
        movieId: parseInt(movieId),
      },
    });
    res.status(204).send();
  } catch (err) {
    console.error(err);
    res.status(500).send('Server error removing movie from list');
  }
});

// Delete a custom list
router.delete('/:listId', async (req, res) => {
  const { listId } = req.params;
  try {
    // First delete all movies in the list, then delete the list itself
    await prisma.listMovie.deleteMany({ where: { listId: parseInt(listId) } });
    await prisma.list.delete({ where: { id: parseInt(listId) } });
    res.status(204).send();
  } catch (err) {
    console.error(err);
    res.status(500).send('Server error deleting list');
  }
});


module.exports = router;
```

**Step 2: Use the custom lists routes in the server**

Modify `server/server.js` (after `app.use('/api/watchlist', watchlistRouter);`):
```javascript
// ... existing code ...
const listsRouter = require('./routes/lists');
app.use('/api/lists', listsRouter);
// ... existing code ...
```

**Step 3: Commit the custom lists API endpoints with Prisma**

```bash
git add server/routes/lists.js server/server.js
git commit -m "feat: implement custom lists API endpoints with Prisma"
```

### Task 5: Integrate the Frontend with the New APIs (Favorites, Watchlist, Lists)

**Files:**
- Create: `src/services/backendApiService.js`
- Modify: `src/services/movieDataService.js` (to use `BackendApiService`)
- Modify: Relevant React components (e.g., `FavoritesPage.jsx`, `WatchingListPage.jsx`, `MovieCard.jsx`) to call `BackendApiService`.

**Step 1: Create `src/services/backendApiService.js`**

```javascript
const BASE_URL = 'http://localhost:3001/api';

export class BackendApiService {
  // --- Favorites ---
  static async getFavorites(userId) {
    const response = await fetch(`${BASE_URL}/favorites/${userId}`);
    if (!response.ok) throw new Error('Failed to fetch favorites');
    return response.json();
  }

  static async addFavorite(userId, movieId) {
    const response = await fetch(`${BASE_URL}/favorites`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId, movieId }),
    });
    if (!response.ok) throw new Error('Failed to add favorite');
  }

  static async removeFavorite(userId, movieId) {
    const response = await fetch(`${BASE_URL}/favorites`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId, movieId }),
    });
    if (!response.ok) throw new Error('Failed to remove favorite');
  }

  // --- Watchlist ---
  static async getWatchlist(userId) {
    const response = await fetch(`${BASE_URL}/watchlist/${userId}`);
    if (!response.ok) throw new Error('Failed to fetch watchlist');
    return response.json();
  }

  static async addWatchlist(userId, movieId) {
    const response = await fetch(`${BASE_URL}/watchlist`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId, movieId }),
    });
    if (!response.ok) throw new Error('Failed to add to watchlist');
  }

  static async removeWatchlist(userId, movieId) {
    const response = await fetch(`${BASE_URL}/watchlist`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId, movieId }),
    });
    if (!response.ok) throw new Error('Failed to remove from watchlist');
  }

  // --- Custom Lists ---
  static async getLists(userId) {
    const response = await fetch(`${BASE_URL}/lists/${userId}`);
    if (!response.ok) throw new Error('Failed to fetch lists');
    return response.json();
  }

  static async createList(userId, name) {
    const response = await fetch(`${BASE_URL}/lists`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId, name }),
    });
    if (!response.ok) throw new Error('Failed to create list');
    return response.json();
  }

  static async addMovieToList(listId, movieId) {
    const response = await fetch(`${BASE_URL}/lists/${listId}/movies`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ movieId }),
    });
    if (!response.ok) throw new Error('Failed to add movie to list');
  }

  static async removeMovieFromList(listId, movieId) {
    const response = await fetch(`${BASE_URL}/lists/${listId}/movies`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ movieId }),
    });
    if (!response.ok) throw new Error('Failed to remove movie from list');
  }

  static async deleteList(listId) {
    const response = await fetch(`${BASE_URL}/lists/${listId}`, {
      method: 'DELETE',
    });
    if (!response.ok) throw new Error('Failed to delete list');
  }
}
```

**Step 2: Modify `src/services/movieDataService.js` to use `BackendApiService`**

This step will involve refactoring `movieDataService.js` to use the new `BackendApiService` for all user-specific data operations (favorites, watchlist, and potentially custom lists). This will require changes to `fetchFavorites`, `addToFavorites`, `removeFromFavorites`, and similar methods for watchlist and lists.

*Note: Since the existing `movieDataService.js` was not provided, this step is conceptual. I will need to read its content to make precise modifications during implementation.*

**Step 3: Modify Relevant React Components**

Update components like `FavoritesPage.jsx`, `WatchingListPage.jsx`, `MovieCard.jsx`, etc., to dispatch actions that call the `BackendApiService` methods.

**Step 4: Commit the frontend integration**

```bash
git add src/services/backendApiService.js src/services/movieDataService.js <other_frontend_component_files>
git commit -m "feat: integrate frontend with new backend APIs (Prisma)"
```
